---
title: "Constructing Exact design using Simulating Annealing"
subtitle: | 
  | Non-linear models: Peleg model and MM model
author: |
  | Chi-Kuang Yeh
  | University of Waterloo
date: "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: ref.bib
output:
  rmarkdown::html_document:
    theme: readable
    code_folding: hide
    toc: true
    toc_float: yes
    number_sections: true
link-citations: yes
urlcolor: blue
linkcolor: red
---

# Summary of the models

| Model | Criterion | # of point in exact (n) | Exact  | Approximate | 
| :-------- | :------- | :-------- | :-------: | :-------: |
| Second-order (with interaction) | A | 9|  | x |
|  | D |  | x |  |
|  | A | 15 | x ||
|  |D | |  | x|
|  | A | 20 |  |x |
|  |D | | |x |
| Peleg model| A | 9|  | x |
|  | D |  |  | x |
|  | A | 15 | | x |
|  |D | |  | x|
|  | A | 20 |  |x |
| MM model | D | 9| x |  |

<!-- latex macros -->
\newcommand{\btheta}{\boldsymbol{\theta}}
\newcommand{\ep}{\varepsilon}
\newcommand{\E}{\mathbb E}

The second order model is 
$$y = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \beta_{11}x_1^2 + \beta_{22}x_2^2 + \beta_{12}x_1 x_2 +\ep$$

```{r setup, message = F}
library(tibble)
library(dplyr)
library(janitor) # to add the sum/total
library(knitr)
library(kableExtra)
my_kable <- function(tbl, my_string) {
  tbl %>% rowid_to_column("ID") %>%  adorn_totals("row") %>%
    kbl(., caption = my_string) %>%
    kable_paper("hover", full_width = F)
}
make_tbl_loss_1d_D <- function(design_app_tbl, design_ex_tbl, f, beta){
  tibble(tyep = c("approx", "exact"),
        loss = c(calc_loss_1d(design_app_tbl, beta, q = length(beta),
                                f = f)$Dopt, 
                calc_loss_1d(design_ex_tbl, beta, q = length(beta),
                                f = f)$Dopt)) %>% 
  mutate(across(where(is.numeric), ~ num(., digits = 5)))
}
make_tbl_loss_1d_A <- function(design_app_tbl, design_ex_tbl, f, beta){
  tibble(tyep = c("approx", "exact"),
        loss = c(calc_loss_1d(design_app_tbl, beta, q = length(beta),
                                f = f)$Aopt, 
                calc_loss_1d(design_ex_tbl, beta, q = length(beta),
                                f = f)$Aopt)) %>% 
  mutate(across(where(is.numeric), ~ num(., digits = 5)))
}

partial_deri_poly <- function(xi, wi, beta){
  fxi <- c(1, xi, xi^2, xi^3) 
  wi * fxi %o% fxi
}
partial_deri_peleg <- function(xi, wi, beta){
  deno <- (beta[1] + xi * beta[2])^2
  fxi <- c(-xi/deno, -xi^2/deno)
  wi * fxi %o% fxi
}
partial_deri_mm <- function(xi, wi, beta){
  fxi <- c(xi/(beta[2] + xi), -beta[1]*xi/(beta[2] + xi)^2)
  wi * fxi %o% fxi
}

calc_loss_1d <- function(design, beta, q, f){
  point <- design$x
  weight <- design$weight
  n_x <- nrow(design) 
  FIM <- matrix(0, nrow = q, ncol = q)
  for(i in 1:n_x){
    FIM <- FIM + f(point[i], weight[i], beta)
  }
  # 
  list(Dopt = -log(det(FIM)^(1/q)),
       Aopt = sum(diag(solve(FIM)))
  )
}
```

# Non-linear models

## Peleg model

From, @paquet:2015:peleg , we have the Peleg model with design space $\chi=[0,180]$, and the parameters $\boldsymbol{\theta}= (0.5,0.05)^\top$. We set $N=51$ and $n=20$. The peleg model is

$$ \mathbb Ey_i= y_0 + \frac{x_i}{\theta_1+\theta_2 x_i}+\varepsilon_i,\quad i=1,\cdots,n.$$

### D-optimality

```{r, include=F}
design_app_D <- matrix(c(9, 180,
                       0.5, 0.5),
                     byrow = T, nrow = 2)
beta <- c(0.5, 0.05)
```

#### n = 9

```{r}
n <- 9
design_ex <- matrix(c(8.926, 8.9864, 9.0148, 9.0463, 180,
                    rep(1,4), 5), byrow = T, nrow = 2)
design_app_tbl <- tibble(x = design_app_D[1,], 
                         weight = design_app_D[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n, 
                           n_point = design_ex[2,])

design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]")
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")

make_tbl_loss_1d_D(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
```


#### n = 10

```{r}
n <- 10;

design_ex <- matrix(c(8.915, 8.9442, 8.9664, 9.0023, 9.1037, 180,
                      rep(1, 5), 5),
                      byrow = T, nrow = 2)
design_app_tbl<- tibble(x = design_app_D[1,], 
                            weight = design_app_D[2,])
design_ex_tbl <- tibble(x = design_ex[1,], n_point = design_ex[2,],
                           weight = design_ex[2,]/n)

design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]")
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")

make_tbl_loss_1d_D(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
```

#### n = 15

```{r}
n <- 15;

design_ex <- matrix(c(8.9134, 8.9553, 8.9601, 9.007, 9.0164, 9.0616, 9.0683, 9.0727, 180,
                      rep(1, 8), 7),
                      byrow = T, nrow = 2)
design_app_tbl<- tibble(x = design_app_D[1,], 
                        weight = design_app_D[2,])
design_ex_tbl <- tibble(x = design_ex[1,], n_point = design_ex[2,],
                        weight = design_ex[2,]/n)

design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]")
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")

make_tbl_loss_1d_D(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
```


### A-optimality

```{r}
beta <- c(0.5, 0.05)
design_app_A <- matrix(c(6.48, 180,
                       0.85157, 0.14843),
                     byrow = T, nrow = 2)
```

#### n = 9

```{r}
n <- 9;
design_ex <- matrix(c( 6.0701, 6.0702, 6.0704, 6.0709, 6.0713, 6.0716, 6.0717, 6.0723, 180,
                       rep(1, 9)), byrow = T, nrow = 2)

design_app_tbl <- tibble(x = design_app_A[1,], weight = design_app_A[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n, n_point = design_ex[2,])
design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]") 
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")
  
make_tbl_loss_1d_A(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
```

#### n = 10

```{r}
n = 10
design_ex <- matrix(c(6.8964, 6.8976, 6.8981, 6.8994, 6.9009, 6.9013, 6.9017, 180,
                    rep(1, 3), 2, rep(1,3), 2),
                      byrow = T, nrow = 2)

design_app_tbl <- tibble(x = design_app_A[1,], weight = design_app_A[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n, n_point = design_ex[2,])
design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]") 
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")
  
make_tbl_loss_1d_A(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
  
```


#### n = 15

```{r}
n = 15
design_ex <- matrix(c( 6.3208, 6.3231, 6.3234, 6.3244, 6.3259, 6.3261, 6.3267,6.3268,6.3272,       
                       6.3278, 6.3283, 6.3293, 180,
                       2, rep(1,11),2 ),
                      byrow = T, nrow = 2)

design_app_tbl <- tibble(x = design_app_A[1,], weight = design_app_A[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n, n_point = design_ex[2,])
design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]") 
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")
  
make_tbl_loss_1d_A(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
  
```

#### n = 20

```{r}
n <- 20
design_ex <- matrix(c( 5.9247, 5.925, 5.9251, 5.9257, 5.9258, 5.9263, 5.9264,
                       5.9271, 5.9274, 5.9275, 5.9278, 5.928, 5.9281, 180,
                       rep(1, 4), 3, 1, 2, rep(1, 4), 3, 1, 2),
                      byrow = T, nrow = 2)

design_app_tbl <- tibble(x = design_app_A[1,], weight = design_app_A[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n, n_point = design_ex[2,])
design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]") 
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")
  
make_tbl_loss_1d_A(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
```

## Michaelis-Menten model

Based on @yin:2017:mm, the parameters is $\btheta=(1,1)^\top$ with design space $\chi=[0,4]$ . We further set $N=51$ and $n=20$. The MM model is

$$ \mathbb Ey_i= \frac{\theta_1x_i}{\theta_2+x_i},\quad i=1,\cdots,n.$$

### D-optmality

```{r}
n <- 20; N <- 51
beta <- c(1, 1)
design_app <- matrix(c(0.64, 4,
                       0.5, 0.5),
                     byrow = T, nrow = 2)
design_ex <- matrix(c(
  0.6657,       0.6661,       0.6665,       0.6668,       0.6669,       0.6671,       0.6673,       0.6674,       0.6679, 0.6685,            4,
  
  
  rep(1,10), 10),
                      byrow = T, nrow = 2)


design_app_tbl <- tibble(x = design_app[1,], weight = design_app[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n, n_point = design_ex[2,])
design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]") 
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")


make_tbl_loss_1d_D(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_mm, beta = beta)
```

### A-optmality

```{r}
design_paper <- matrix(c(6.9, 180))
```

