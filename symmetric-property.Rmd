---
title: "Constructing Exact design using Simulating Annealing"
subtitle: | 
  | "Non-linear models with discussion about the symmetric property"
author: |
  | Chi-Kuang Yeh
  | University of Waterloo
date: "`r format(Sys.time(), '%d %B, %Y')`"
bibliography: ref.bib
output:
  rmarkdown::html_document:
    theme: readable
    code_folding: hide
    toc: true
    toc_float: yes
    number_sections: true
link-citations: yes
urlcolor: blue
linkcolor: red
---

<!-- latex macros -->
\newcommand{\btheta}{\boldsymbol{\theta}}
\newcommand{\ep}{\varepsilon}
\newcommand{\E}{\mathbb E}

```{r setup, message = F}
library(tibble)
library(dplyr)
library(janitor) # to add the sum/total
library(knitr)
library(kableExtra)
my_kable <- function(tbl, my_string) {
  tbl %>% rowid_to_column("ID") %>%  adorn_totals("row") %>%
    kbl(., caption = my_string) %>%
    kable_paper("hover", full_width = F)
}
make_tbl_loss_1d_D <- function(design_app_tbl, design_ex_tbl, f, beta){
  tibble(tyep = c("approx", "exact"),
        loss = c(calc_loss_1d(design_app_tbl, beta, q = length(beta),
                                f = f)$Dopt, 
                calc_loss_1d(design_ex_tbl, beta, q = length(beta),
                                f = f)$Dopt)) %>% 
  mutate(across(where(is.numeric), ~ num(., digits = 5)))
}
make_tbl_loss_1d_A <- function(design_app_tbl, design_ex_tbl, f, beta){
  tibble(tyep = c("approx", "exact"),
        loss = c(calc_loss_1d(design_app_tbl, beta, q = length(beta),
                                f = f)$Aopt, 
                calc_loss_1d(design_ex_tbl, beta, q = length(beta),
                                f = f)$Aopt)) %>% 
  mutate(across(where(is.numeric), ~ num(., digits = 5)))
}

partial_deri_poly <- function(xi, wi, beta){
  fxi <- c(1, xi, xi^2, xi^3) 
  wi * fxi %o% fxi
}
partial_deri_peleg <- function(xi, wi, beta){
  deno <- (beta[1] + xi * beta[2])^2
  fxi <- c(-xi/deno, -xi^2/deno)
  wi * fxi %o% fxi
}
partial_deri_mm <- function(xi, wi, beta){
  fxi <- c(xi/(beta[2] + xi), -beta[1]*xi/(beta[2] + xi)^2)
  wi * fxi %o% fxi
}

calc_loss_1d <- function(design, beta, q, f){
  point <- design$x
  weight <- design$weight
  n_x <- nrow(design) 
  FIM <- matrix(0, nrow = q, ncol = q)
  for(i in 1:n_x){
    FIM <- FIM + f(point[i], weight[i], beta)
  }
  # 
  list(Dopt = -log(det(FIM)^(1/q)),
        Aopt = sum(diag(solve(FIM)))
  )
}
```

<!-- # A-optimality -->

<!-- $N = 21, n=30$ -->

<!-- ```{r} -->

<!-- n <- 50 -->

<!-- design_app <- matrix(c(-1, -0.5, -0.4, 0.4, 0.5, 1, -->

<!--                         0.15403, 0.28688, 0.059094, 0.059094, 0.28688, 0.15403), -->

<!--                      byrow = T, nrow = 2) -->

<!-- design_ex <- matrix(c(-1, -0.4778, -0.4775, -0.4764, -0.4754, -0.4746, -0.4741,  -->

<!--                       -0.4734, -0.4724, -0.4718, -0.4712, -0.4691, 0.4457,  -->

<!--                       0.4484, 0.4504, 0.4522, 0.453, 0.4531, 0.4535, 0.4553, -->

<!--                       0.458, 0.4605, 1, -->

<!--                       5, 1, 1, 1, 1, 1, 1, 1, 1,  1,1, 1, 1, 1, 1, 1, 1, 1,  -->

<!--                       1,1,1,1,4), -->

<!--                     byrow = T, nrow = 2) -->

<!-- design_weight <- design_ex[2,]/n -->

<!-- res_design_app <- tibble(x = design_app[1,], n_point = NA, weight = design_app[2,]) -->

<!-- res_design_ex <- tibble(x = design_ex[1,], n_point = design_ex[2,], weight = design_weight) -->

<!-- tibble(tyep = c("approx", "exact"), -->

<!--        loss = c(calc_loss_poly(res_design_app, 3)$Aopt,  -->

<!--                 calc_loss_poly(res_design_ex, 3)$Aopt)) -->

<!-- res_design_app %>% rowid_to_column("ID") %>%  adorn_totals("row") %>% -->

<!--   kbl(., caption = "Approximate A-design on [-1,1]") %>% -->

<!--   kable_paper("hover", full_width = F) -->

<!-- res_design_ex %>% rowid_to_column("ID") %>%  adorn_totals("row") %>% -->

<!--   kbl(., caption = "Exact A-design (n=30) on [-1,1]") %>% -->

<!--   kable_paper("hover", full_width = F) -->

<!-- ``` -->

<!-- # Logistic regression -->

<!-- $\chi=[-1,1]^2$, $N_1 = N_2=11$, and $n=50$. -->

<!-- ```{r, eval = F, include = F} -->

<!-- design_app <- matrix(c( -1, -1, 0.18746, -->

<!--                         -1, 1, 0.26431, -->

<!--                         1, -1, 0.27694, -->

<!--                         1, 1, 0.27129) , byrow = T, ncol = 3) -->

<!-- design_ex <- matrix(c( -0.995,       0.7156, 1, -->

<!--                        -0.9841,       0.0234, 1, -->

<!--                        -0.9754,      -0.8151, 1, -->

<!--                        -0.9615,        0.699, 1,  -->

<!--                        -0.9492,       0.9309,            1, -->

<!--                        -0.948,       0.8542,            1, -->

<!--                        -0.9454,       0.4869,            1, -->

<!--                        -0.9253,       0.6351,            1, -->

<!--                        -0.9209,      -0.8185,            1, -->

<!--                        -0.9202,      -0.8886,            1, -->

<!--                        -0.9186,       0.7417,            1, -->

<!--                        -0.907,      -0.7475,            1, -->

<!--                        -0.9066,       0.9206,            1, -->

<!--                        -0.903,       0.9033,            1, -->

<!--                        -0.8428,      -0.6299,            1, -->

<!--                        -0.7917,       0.7817,            1, -->

<!--                        -0.7205,       0.1444,            1, -->

<!--                        -0.6765,      -0.9676,            1, -->

<!--                        -0.6438,      -0.4823,            1, -->

<!--                        -0.6264,      -0.8403,            1, -->

<!--                        -0.5828,      -0.9855,            1, -->

<!--                        -0.5682,       0.7846,            1, -->

<!--                        -0.4929,       -0.031,            1, -->

<!--                        -0.4438,       0.8747,            1, -->

<!--                        0.385,      -0.7956,            1, -->

<!--                        0.4071,            1,            1, -->

<!--                        0.4429,       0.9867,            1, -->

<!--                        0.4618,      -0.8781,            1, -->

<!--                        0.4656,       -0.579,            1, -->

<!--                        0.5103,       0.9324,            1, -->

<!--                        0.5493,      -0.7965,            1, -->

<!--                        0.5566,       0.8978,            1, -->

<!--                        0.5713,       0.9155,            1, -->

<!--                        0.6174,      -0.9465,            1, -->

<!--                        0.6185,      -0.8972,            1, -->

<!--                        0.6631,      -0.6967,            1, -->

<!--                        0.7023,       0.8554,            1, -->

<!--                        0.7247,       0.9159,            1, -->

<!--                        0.7729,      -0.6749,            1, -->

<!--                        0.8074,       -0.998,            1, -->

<!--                        0.8104,         0.92,            1, -->

<!--                        0.8376,      -0.9333,            1, -->

<!--                        0.8689,       0.7049,            1, -->

<!--                        0.8691,      0.9561,            1, -->

<!--                        0.8908,      -0.9609,            1, -->

<!--                        0.9266,      -0.9648,            1, -->

<!--                        0.9524,       0.9742,            1, -->

<!--                        0.957,        0.751,            1,  -->

<!--                        0.9862,       0.9615,            1, -->

<!--                        0.9936,      -0.8034,            1),  -->

<!--                     byrow = T, ncol = 3) -->

<!-- beta <- c(-0.5, 0.7, 0.38) -->

<!-- # beta = c(-0.4926, -0.6280, -0.3283) -->

<!-- partial_logit <- function(x, w, beta){ -->

<!--   rx <- c(1, x) -->

<!--   Gamma <- exp(t(beta) %*% rx)/(1+exp(t(beta) %*% rx ))^2 -->

<!--   w * c(Gamma) * (rx %*% t(rx)) -->

<!-- } -->

<!-- calc_loss <- function(design, beta, q){ -->

<!--   point <- design[, c(1,2)] -->

<!--   weight <- design[, 3] -->

<!--   n_x <- nrow(design)  -->

<!--   n_param <- length(beta) -->

<!--   FIM <- matrix(0, nrow = q, ncol = q) -->

<!--   for(i in 1:n_x){ -->

<!--     FIM <- FIM + partial_logit(point[i,c(1,2)], weight[i], beta) -->

<!--   } -->

<!--   #  -->

<!--   list(Dopt = -log(det(FIM)^(1/(n_param))), -->

<!--        Aopt = sum(diag(solve(FIM))) -->

<!--   ) -->

<!-- } -->

<!-- design_weight <- design_ex[,3]/n -->

<!-- # res_design_app <- tibble(x = design_app[1,], n_point = NA, weight = design_app[2,]) -->

<!-- res_design_ex <- tibble(x1 = design_ex[,1], x2 = design_ex[,2], -->

<!--                         n_point = design_ex[,3],  -->

<!--                         weight = design_weight) -->

<!-- res_design_ex %>% rowid_to_column("ID") %>%  adorn_totals("row") %>%  -->

<!--   kbl() %>% kable_paper("hover", full_width = F) -->

<!-- calc_loss(design = design_app, beta = beta)$Dopt -->

<!-- calc_loss(design = cbind(design_ex[,-3], design_weight), beta = beta)$Dopt -->

<!-- ``` -->

# Non-linear models


## Peleg model

From, @paquet:2015:peleg , we have the Peleg model with design space $\chi=[0,180]$, and the parameters $\boldsymbol{\theta}= (0.5,0.05)^\top$. We set $N=51$ and $n=20$. The peleg model is

$$ \mathbb Ey_i= y_0 + \frac{x_i}{\theta_1+\theta_2 x_i}+\varepsilon_i,\quad i=1,\cdots,n.$$

### D-optimality

#### n = 10

```{r}
n <- 10;
beta <- c(0.5, 0.05)
design_app <- matrix(c(9, 180,
                       0.5, 0.5),
                     byrow = T, nrow = 2)
design_ex <- matrix(c(8.915, 8.9442, 8.9664, 9.0023, 9.1037, 180,
                      rep(1, 5), 5),
                      byrow = T, nrow = 2)

design_app_tbl <- tibble(x = design_app[1,], weight = design_app[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n)

design_weight <- design_ex[,3]/n
design_app_tibble <- tibble(design_pt = design_app[1,], weight = design_app[2,])
design_ex_tibble <- tibble(design_pt = design_ex[1,], n_point = design_ex[2,])

design_app_tibble %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]")
design_ex_tibble %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")

make_tbl_loss_1d_D(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
```

### 
### A-optimality

```{r}
n <- 20; N <- 51
beta <- c(0.5, 0.05)
design_app <- matrix(c(0.48, 4,
                       0.67578, 0.32422),
                     byrow = T, nrow = 2)
design_ex <- matrix(c(0.4897, 0.4898, 0.49, 0.4901, 0.4902, 0.4904, 0.4907, 0.4908, 0.4909,
                      0.491, 0.4914, 0.4918, 4,
                      rep(1,6), 2,2,1,1,1,1,6),
                      byrow = T, nrow = 2)

design_weight <- design_ex[,3]/n
design_app_tibble <- tibble(design_pt = design_app[1,], weight = design_app[2,])
design_ex_tibble <- tibble(design_pt = design_ex[1,], n_point = design_ex[2,], 
                           weight = design_ex[2,]/n )

design_app_tibble %>% my_kable(., "Approximate A-design of Peleg with N=51, on [-1,1]")

design_ex_tibble %>% my_kable(., "Exact A-design (n=20) of Peleg, on [-1,1]") 

make_tbl_loss_1d_A(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_peleg, beta = beta)
```


## Michaelis-Menten model

Based on @yin:2017:mm, the parameters is $\btheta=(1,1)^\top$ with design space $\chi=[0,4]$ . We further set $N=51$ and $n=20$. The MM model is

$$ \mathbb Ey_i= \frac{\theta_1x_i}{\theta_2+x_i},\quad i=1,\cdots,n.$$

### D-optmality

```{r}
n <- 20; N <- 51
beta <- c(1, 1)
design_app <- matrix(c(0.64, 4,
                       0.5, 0.5),
                     byrow = T, nrow = 2)
design_ex <- matrix(c(
  0.6657,       0.6661,       0.6665,       0.6668,       0.6669,       0.6671,       0.6673,       0.6674,       0.6679, 0.6685,            4,
  
  
  rep(1,10), 10),
                      byrow = T, nrow = 2)


design_app_tbl <- tibble(x = design_app[1,], weight = design_app[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n, n_point = design_ex[2,])
design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]") 
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")


make_tbl_loss_1d_D(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_mm, beta = beta)
```

### A-optmality

```{r}
n <- 20; N <- 51
beta <- c(1, 1)
design_app <- matrix(c(0.48, 4,
                       0.67578, 0.32422),
                     byrow = T, nrow = 2)
design_ex <- matrix(c(0.4897, 0.4898, 0.49, 0.4901, 0.4902, 0.4904, 0.4907, 0.4908, 0.4909,
                      0.491, 0.4914, 0.4918, 4,
                      rep(1,6), 2,2,1,1,1,1,6),
                      byrow = T, nrow = 2)

design_app_tbl <- tibble(x = design_app[1,], weight = design_app[2,])
design_ex_tbl <- tibble(x = design_ex[1,], weight = design_ex[2,]/n, n_point = design_ex[2,])
design_app_tbl %>% my_kable(., "Approximate D-design of Peleg, on [-1,1]") 
design_ex_tbl %>% my_kable(., "Exact D-design (n=20) of Peleg, on [-1,1]")
  
make_tbl_loss_1d_A(design_app_tbl, design_ex_tbl, 
                   f = partial_deri_mm, beta = beta)
```



